---
import { ArrowLeft, ArrowRight, Loader2 } from "@lucide/astro";
import type { HTMLAttributes } from "astro/types";

interface BaseProps {
  variant?:
    | "primary"
    | "secondary"
    | "accent"
    | "destructive"
    | "ghost"
    | "outline";
  size?: "xs" | "sm" | "md" | "lg" | "xl";
  withIcon?: boolean;
  iconPosition?: "left" | "right";
  disabled?: boolean;
  loading?: boolean;
  fullWidth?: boolean;
  // Reutilizamos 'rounded' para controlar la agresividad del corte angular
  rounded?: "none" | "sm" | "md" | "lg";
  animation?: "pulse" | "glitch" | "float" | "none";
}

type Props =
  | (BaseProps & HTMLAttributes<"button">)
  | ({ href: string } & BaseProps & HTMLAttributes<"a">);

const {
  variant = "primary",
  size = "md",
  withIcon = false,
  iconPosition = "right",
  disabled = false,
  loading = false,
  fullWidth = false,
  rounded = "md",
  animation = "none",
  class: className,
  ...props
} = Astro.props;

// --- ESTILOS BASE ---
const baseStyles = `
  group relative
  inline-flex items-center justify-center gap-2
  font-sans font-bold uppercase tracking-widest
  whitespace-nowrap
  overflow-visible
  focus-visible:outline-none
  disabled:pointer-events-none disabled:opacity-50 disabled:grayscale
  transition-all duration-200 ease-out
  transform-gpu
  cursor-pointer select-none
  text-sm
`;

// --- FORMAS ANGULARES (CLIP-PATHS) ---
// Mapeamos la prop 'rounded' a cortes agresivos
const getClipPath = (r: string) => {
  switch (r) {
    case "none": return "clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);"; // Cuadrado puro
    case "sm":   return "clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);"; // Una esquina cortada abajo derecha
    case "md":   return "clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);"; // Corte arriba izq y abajo der
    case "lg":   return "clip-path: polygon(15% 0, 100% 0, 100% 70%, 85% 100%, 0 100%, 0 30%);"; // Cortes extremos (Ciber-técnico)
    default:     return "clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);";
  }
};

const clipPathStyle = getClipPath(rounded);

// --- VARIANTES DE COLOR Y EFECTOS ---
const variantStyles = {
  primary: `
    bg-[oklch(var(--primary))]
    text-[oklch(var(--background))]
    border-none
    hover:shadow-[0_0_20px_oklch(var(--primary))]
    hover:-translate-y-0.5
    active:scale-95
    active:bg-[oklch(var(--primary-foreground))]
    active:text-[oklch(var(--primary))]
  `,
  secondary: `
    bg-[oklch(var(--background))]
    text-[oklch(var(--secondary))]
    border border-[oklch(var(--secondary))]
    hover:bg-[oklch(var(--secondary))]
    hover:text-[oklch(var(--background))]
    hover:shadow-[0_0_15px_oklch(var(--secondary))]
    active:scale-95
  `,
  accent: `
    bg-[oklch(var(--accent))]
    text-[oklch(var(--background))]
    border-none
    hover:shadow-[0_0_20px_oklch(var(--accent))]
    hover:-translate-y-0.5
    active:scale-95
  `,
  destructive: `
    bg-transparent
    text-[oklch(var(--destructive))]
    border border-[oklch(var(--destructive))]
    hover:bg-[oklch(var(--destructive))]
    hover:text-[oklch(var(--background))]
    hover:shadow-[0_0_15px_oklch(var(--destructive))]
    active:scale-95
  `,
  ghost: `
    bg-transparent
    text-[oklch(var(--muted-foreground))]
    border border-transparent
    hover:text-[oklch(var(--foreground))]
    hover:border-[oklch(var(--foreground))]
    active:scale-95
  `,
  outline: `
    bg-transparent
    text-[oklch(var(--primary))]
    border border-[oklch(var(--primary))]
    hover:bg-[oklch(var(--primary))]
    hover:text-[oklch(var(--background))]
    hover:shadow-[0_0_15px_oklch(var(--primary))]
    active:scale-95
  `,
};

// --- TAMAÑOS ---
const sizeStyles = {
  xs: "px-3 py-1 text-[10px] h-6",
  sm: "px-4 py-1.5 text-xs h-8",
  md: "px-6 py-2 text-sm h-10",
  lg: "px-8 py-3 text-base h-12",
  xl: "px-10 py-4 text-lg h-14",
};

// --- EFECTO SCANLINE (CRT) ---
// Un efecto de línea que cruza el botón
const scanlineEffect = `
  before:content-[''] before:absolute before:inset-0 before:bg-white/10
  before:translate-y-[-100%] before:skew-y-12
  group-hover:before:animate-scan
  group-hover:before:transition-none
`;

// Decoraciones de esquinas para variantes 'outline'
const cornerDecorations = (variant === 'outline' || variant === 'secondary') ? `
  after:content-[''] after:absolute after:inset-[1px] 
  after:bg-[oklch(var(--background))] 
  after:z-[-1] after:opacity-50
` : '';

---

{ 'href' in props ? (
  <a
    class:list={[
      baseStyles,
      variantStyles[variant],
      sizeStyles[size],
      animation === "pulse" && "animate-pulse-fast",
      animation === "float" && "animate-float",
      animation === "glitch" && "animate-glitch-hover",
      fullWidth && "w-full",
      className,
    ]} 
    style={clipPathStyle}
    {...props}
  >
    <div class:list={[scanlineEffect, cornerDecorations]}></div>

    <!-- Loading Spinner -->
    {loading && (
      <Loader2 class="size-4 animate-spin text-current" />
    )}

    <!-- Left Icon -->
    {withIcon && iconPosition === "left" && !loading && (
      <span class="group-hover:-translate-x-1 transition-transform">
        <slot name="icon-left">
          <ArrowLeft name="lucide:arrow-left" class="size-4" />
        </slot>
      </span>
    )}

    <span class="relative z-10 flex items-center gap-2">
      <slot />
    </span>

    <!-- Right Icon -->
    {withIcon && iconPosition === "right" && !loading && (
      <span class="group-hover:translate-x-1 transition-transform">
        <slot name="icon-right">
          <ArrowRight name="lucide:arrow-right" class="size-4" />
        </slot>
      </span>
    )}
  </a>
) : (
  <button
    class:list={[
      baseStyles,
      variantStyles[variant],
      sizeStyles[size],
      animation === "pulse" && "animate-pulse-fast",
      animation === "float" && "animate-float",
      animation === "glitch" && "animate-glitch-hover",
      fullWidth && "w-full",
      className,
    ]} 
    style={clipPathStyle}
    disabled={disabled || loading}
    {...props}
  >
    <div class:list={[scanlineEffect, cornerDecorations]}></div>

    <!-- Loading Spinner -->
    {loading && (
      <Loader2 class="size-4 animate-spin text-current" />
    )}

    <!-- Left Icon -->
    {withIcon && iconPosition === "left" && !loading && (
      <span class="group-hover:-translate-x-1 transition-transform">
        <slot name="icon-left">
          <ArrowLeft name="lucide:arrow-left" class="size-4" />
        </slot>
      </span>
    )}

    <span class="relative z-10 flex items-center gap-2">
      <slot />
    </span>

    <!-- Right Icon -->
    {withIcon && iconPosition === "right" && !loading && (
      <span class="group-hover:translate-x-1 transition-transform">
        <slot name="icon-right">
          <ArrowRight name="lucide:arrow-right" class="size-4" />
        </slot>
      </span>
    )}
  </button>
)}

<style>
  @keyframes scan {
    0% { transform: translateY(-100%) skewY(12deg); }
    100% { transform: translateY(200%) skewY(12deg); }
  }
  
  .animate-scan {
    animation: scan 0.75s linear infinite;
  }

  /* Animación personalizada para el glitch hover */
  @keyframes glitch-skew {
    0% { transform: skew(0deg); }
    20% { transform: skew(-2deg); }
    40% { transform: skew(2deg); }
    60% { transform: skew(-1deg); }
    80% { transform: skew(1deg); }
    100% { transform: skew(0deg); }
  }
  
  .animate-glitch-hover:hover {
    animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
    color: oklch(var(--primary));
  }
</style>